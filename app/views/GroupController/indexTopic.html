#{extends 'group_templeate.html' /} #{set title:'topic messages' /}
%{
	long userId = utils.SessionHelper.getCurrentUser(session)?.id;
	boolean isAdmin = utils.SessionHelper.getCurrentUser(session)?.role == models.User.ROLE_ADMIN;
	boolean adminGroup = utils.SessionHelper.getCurrentUser(session)?.role == models.User.ROLE_GROUP_ADMIN; 
	boolean currentGroupAdmin = (utils.SessionHelper.getCurrentUser(session)?.command?.id == group.id) && (adminGroup); 
	boolean notInGroup = utils.SessionHelper.getCurrentUser(session)?.command == null; 
	boolean wasInviteToThisGroup = utils.SessionHelper.getCurrentUser(session)?.commandToInvite?.id == group.id;
	boolean wasNotInviteToGroup = utils.SessionHelper.getCurrentUser(session)?.commandToInvite == null;
	boolean wasInviteToOtherGroup = (utils.SessionHelper.getCurrentUser(session)?.commandToInvite != null) && (utils.SessionHelper.getCurrentUser(session)?.commandToInvite?.id !=group.id);
 	boolean groupMember = (utils.SessionHelper.getCurrentUser(session)?.command?.id == group.id);
%}

<div class="tabs clearFix">
	<a href="@{GroupController.index(group.id)}" >Описание</a> <a href="@{GroupController.groupTopics(group.id)}" class="act">Обсуждения</a> <a
		href="@{GroupController.groupUsers(group.id)}" >Участники</a>
</div>
<script type="text/javascript">
function editEnabled(element){
	$(element).parent().parent().parent().find('.msg').show(); 
	$(element).parent().parent().parent().find('.msgRead').hide(); 
	return false;
}
function editDisabled(element){
	$(element).parent().parent().parent().find('.msg').hide(); 
	$(element).parent().parent().parent().find('.msgRead').show(); 
	return false;
}
</script>

                <a href="@{GroupController.groupTopics(group.id)}" class="back"><span>&#8592;&nbsp;</span> К списку всех тем</a>
                #{if (userId == topic.createdUserId) || (isAdmin)}
                <div style="float: right">
                 <a href="@{GroupController.editTopic(topic.id)}"><span class="theme-edit"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}" alt="">Редактировать тему</span></span></a>
                            <a href="@{GroupController.removeTopic(topic.id, group.id)}"><span class="theme-delete"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}" alt="">Удалить тему</span></span></a>
                </div>
                #{/if}
                  <div class="group-theme clearFix">
                    <h2>${topic.name}
					<span class="theme_description">Создана ${topic.createdUserName} ${topic.createdUserLastName}, ${utils.DateUtils.getFormatedStringDate(topic.createdDateTime, true)}</span>
					</h2>
					<div class="theme_description_l">
						#{avatar.avatar user:models.User.findById(topic.createdUserId), cssClass:'group-theme-dialog-pic', maleImg:'avam.png', femaleImg:'avaf.png', avatarSize:55 /}<br />
					</div>
                    <div class="theme_description_r">${topic.description}</div>
				</div>
                
                
                
               
                <div class="group-theme-dialog-ttl">Всего ${topic?.msg?.size()} записи:</div>
                <ul class="group-theme-dialog">
                #{list items:topic.msg, as:'msg'}
               		#{form @GroupController.editMsg()}
	                <input name="msg.id" value="${msg.id}" type="hidden">
					<input name="topicId" value="${topic.id}" type="hidden">
					<input name="groupId" value="${group.id}" type="hidden">
                	<li>
						#{avatar.avatar user:msg.from, cssClass:'group-theme-dialog-pic', maleImg:'avam.png', femaleImg:'avaf.png', avatarSize:55 /}
                        <div class="group-theme-dialog-name">
                        	<a href="@{UserController.index(msg.from?.id)}">${msg.from.name + " " + msg.from.lastName}</a> ${msg.createDate}
                        	#{if (userId == msg.from.id) || (isAdmin)}
                        		<span class="theme-edit" onclick="editEnabled(this);"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}"  alt="" onclick="editEnabled(this);">Редактировать сообщение</span></span>
                        		<a href="@{GroupController.removeMessage(msg.id, group.id)}"><span class="theme-delete"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}" alt="">Удалить тему</span></span></a>
                        	#{/if}
                        </div>
                        <pre class="msgRead">
                        ${msg.text}
                        </pre>
                        <div style="display: none" class="msg group-theme-dialog-form">
			            	<textarea name="msg.text" cols="" rows="">${msg.text} </textarea>
			                <button type="submit" class="group-theme-btn">Сохранить</button>
			                <button type="button" onclick="editDisabled(this);" class="group-theme-btn">Отменить</button>
						</div>
						
                    </li>
                    #{/form}
                #{/list}
				</ul>
    <div class="answer-expand">
					<div class="group-theme-dialog-ttl-color">Всего ${topic?.msg?.size()} записи</div>
					#{form @GroupController.addMsgToTopic()}
	               <input name="topicId" value="${topic.id}" type="hidden"> 
	               <input name="groupId" value="${group.id}" type="hidden">
					<ul class="group-theme-dialog-form">
						<li>
							#{avatar.avatar user:utils.SessionHelper.getCurrentUser(session), cssClass:'group-theme-dialog-pic', maleImg:'avam.png', femaleImg:'avaf.png', avatarSize:55 /}
							<textarea placeholder="Написать ответ..." name="msg.text" cols="" rows="2" autofocus></textarea>
							<button type="submit" class="group-theme-btn">Отправить</button>
						</li>
					</ul>
					#{/form}
				</div>

