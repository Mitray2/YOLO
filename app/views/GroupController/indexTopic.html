#{extends 'group_templeate.html' /} #{set title:'topic messages' /}
%{
	long userId = utils.SessionHelper.getCurrentUser(session)?.id;
	boolean isAdmin = utils.SessionHelper.getCurrentUser(session)?.role == models.User.ROLE_ADMIN;
	boolean adminGroup = utils.SessionHelper.getCurrentUser(session)?.role == models.User.ROLE_GROUP_ADMIN; 
	boolean currentGroupAdmin = (utils.SessionHelper.getCurrentUser(session)?.command?.id == group.id) && (adminGroup); 
	boolean notInGroup = utils.SessionHelper.getCurrentUser(session)?.command == null; 
	boolean wasInviteToThisGroup = utils.SessionHelper.getCurrentUser(session)?.commandToInvite?.id == group.id;
	boolean wasNotInviteToGroup = utils.SessionHelper.getCurrentUser(session)?.commandToInvite == null;
	boolean wasInviteToOtherGroup = (utils.SessionHelper.getCurrentUser(session)?.commandToInvite != null) && (utils.SessionHelper.getCurrentUser(session)?.commandToInvite?.id !=group.id);
 	boolean groupMember = (utils.SessionHelper.getCurrentUser(session)?.command?.id == group.id);
%}

<div class="tabs clearFix">
	<a href="@{GroupController.index(group.id)}" >Описание</a> 
	
		<a href="@{GroupController.publicTopics(group.id)}" #{if topic.publicTopic}  class="act" #{/if}>Открытые обсуждения</a> 
	
	#{if (groupMember) || (isAdmin)}
		<a href="@{GroupController.groupTopics(group.id)}" #{if !topic.publicTopic}  class="act" #{/if}>Обсуждения</a> 
	#{/if} 
	<a href="@{GroupController.groupUsers(group.id)}" >Участники</a>
</div>
<script type="text/javascript">
function editEnabled(element){
	$(element).parent().parent().parent().find('.msg').show(); 
	$(element).parent().parent().parent().find('.msgRead').hide(); 
	return false;
}
function editDisabled(element){
	$(element).parent().parent().parent().find('.msg').hide(); 
	$(element).parent().parent().parent().find('.msgRead').show(); 
	return false;
}

$(document).ready(function(){
    $('.writeComment').autosize({append: "\n"});  
});
</script>


			#{if topic.publicTopic}
				<a href="@{GroupController.publicTopics(group.id)}" class="back"><span>&#8592;&nbsp;</span> К списку всех тем</a>
			#{/if}
			#{else}
                <a href="@{GroupController.groupTopics(group.id)}" class="back"><span>&#8592;&nbsp;</span> К списку всех тем</a>
            #{/else}
                #{if (userId == topic.createdUserId) || (isAdmin)}
                <div style="float: right">
                 <a href="@{GroupController.editTopic(topic.id)}"><span class="theme-edit"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}" alt="">Редактировать тему</span></span></a>
                            <a href="@{GroupController.removeTopic(topic.id, group.id)}"><span class="theme-delete"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}" alt="">Удалить тему</span></span></a>
                </div>
                #{/if}
                  <div class="group-theme clearFix">
                    <h2>${topic.name}
                    <br/>
					<span class="theme_description">Создана ${topic.createdUserName} ${topic.createdUserLastName}, ${utils.DateUtils.getFormatedStringDate(topic.createdDateTime, true)}</span>
					</h2>
					<div class="theme_description_l">
						#{avatar.avatar user:models.User.findById(topic.createdUserId), cssClass:'group-theme-dialog-pic', maleImg:'avam.png', femaleImg:'avaf.png', avatarSize:55 /}<br />
					</div>
                    <div class="theme_description_r"><pre>${topic.description}</pre></div>
				</div>
                
                
                
               
                <div class="group-theme-dialog-ttl">Всего ${topicMessagesCount} записи:</div>
                <ul class="group-theme-dialog">
                #{paginate.list items:topicMessages, as:'msg'}
               		#{form @GroupController.editMsg()}
	                <input name="msg.id" value="${msg.id}" type="hidden">
					<input name="topicId" value="${topic.id}" type="hidden">
					<input name="groupId" value="${group.id}" type="hidden">
                	<li>
						#{avatar.avatar user:msg.from, cssClass:'group-theme-dialog-pic', maleImg:'avam.png', femaleImg:'avaf.png', avatarSize:55 /}
                        <div class="group-theme-dialog-name">
                        	<a href="@{UserController.index(msg.from?.id)}">${msg.from.name + " " + msg.from.lastName}</a> ${msg.createDate}
                        	#{if (userId == msg.from.id) || (isAdmin)}
                        		<span class="theme-edit" onclick="editEnabled(this);"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}"  alt="" onclick="editEnabled(this);">Редактировать сообщение</span></span>
                        		<a href="@{GroupController.removeMessage(msg.id, group.id)}"><span class="theme-delete"><i></i><span><img src="@{'public/images/boilerplate/tooltip-arrow.png'}" alt="">Удалить сообщение</span></span></a>
                        	#{/if}
                        </div>
                        <pre class="msgRead">${msg.text}</pre>
                        <div style="display: none" class="msg">
	                        <div class="group-theme-dialog-form">
				            	<textarea name="msg.text" style="height: 20px" class="writeComment" onBlur="setTimeout('writeEnabled(false)', 100);">${msg.text} </textarea>
				                <button type="submit" class="group-theme-btn">Сохранить</button>
				                <button type="button" onclick="editDisabled(this);" class="group-theme-btn">Отменить</button>
							</div>
						</div>
                    </li>
                    #{/form}
                #{/paginate.list}
				</ul>
				#{paginate.controls items:topicMessages /} 
				
				#{group.reply topic:topic, group:group, count:mainTopicMsgCount, action:'/groupcontroller/addmsgtotopic'/}
